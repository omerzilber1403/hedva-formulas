<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sustainability Study App</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f0f4f8;
      overscroll-behavior: none;
    }

    .card-container {
      perspective: 1000px;
    }

    .card-inner {
      transition: transform 0.55s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
      position: relative;
    }

    .card-inner.flipped {
      transform: rotateY(180deg);
    }

    .card-face {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      position: absolute;
      inset: 0;
      border-radius: 1.25rem;
    }

    .card-back {
      transform: rotateY(180deg);
    }

    .status-unmarked {
      border-left: 4px solid #cbd5e1;
    }

    .status-red {
      border-left: 4px solid #ef4444;
    }

    .status-yellow {
      border-left: 4px solid #f59e0b;
    }

    .status-green {
      border-left: 4px solid #22c55e;
    }

    .no-select {
      user-select: none;
      -webkit-user-select: none;
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .shake {
      animation: shake 0.4s;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0)
      }

      25% {
        transform: translateX(-8px)
      }

      75% {
        transform: translateX(8px)
      }
    }

    .answer-hidden {
      filter: blur(6px);
      user-select: none;
      -webkit-user-select: none;
      transition: filter 0.2s;
    }

    .answer-hidden:active {
      filter: blur(0);
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const loadData = () => {
      const raw = window.__QUIZ_DATA__;
      if (!raw) return [];
      return raw.filter(q => q.question && (q.correct_answer || q.wrong_answers?.length))
        .map(q => ({ ...q, status: 'unmarked' }));
    };

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
    const getStatusColor = s => ({ unmarked: 'bg-slate-400', red: 'bg-red-500', yellow: 'bg-amber-400', green: 'bg-green-500' }[s] || 'bg-slate-400');
    const getStatusBorder = s => ({ unmarked: 'border-slate-300', red: 'border-red-400', yellow: 'border-amber-400', green: 'border-green-400' }[s] || 'border-slate-300');

    // â”€â”€ User Profile Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const USERS_KEY = 'quiz_users_v2';
    const CURRENT_USER_KEY = 'quiz_current_user';
    const loadUsers = () => { try { return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); } catch { return {}; } };
    const saveUsers = data => localStorage.setItem(USERS_KEY, JSON.stringify(data));
    const loadCurrent = () => localStorage.getItem(CURRENT_USER_KEY) || null;
    const saveCurrent = name => localStorage.setItem(CURRENT_USER_KEY, name);
    const clearCurrent = () => localStorage.removeItem(CURRENT_USER_KEY);
    const getUserStatuses = (users, name) => users[name]?.statuses || {};
    const setUserStatuses = (users, name, statuses) => ({ ...users, [name]: { ...users[name], name, statuses } });

    // Cloud Sync Helpers
    const syncCloudUsers = async () => { try { const r = await fetch('/api/users'); if (r.ok) return await r.json(); } catch (e) { } return null; };
    const pushCloudUser = async (name, statuses) => { try { await fetch('/api/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, statuses }) }); } catch (e) { } };

    // â”€â”€ Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const IconCards = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="3" strokeWidth="2" /><line x1="8" y1="4" x2="8" y2="20" strokeWidth="2" /></svg>;
    const IconTest = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>;
    const IconList = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6" strokeWidth="2" /><line x1="8" y1="12" x2="21" y2="12" strokeWidth="2" /><line x1="8" y1="18" x2="21" y2="18" strokeWidth="2" /><line x1="3" y1="6" x2="3.01" y2="6" strokeWidth="2" strokeLinecap="round" /><line x1="3" y1="12" x2="3.01" y2="12" strokeWidth="2" strokeLinecap="round" /><line x1="3" y1="18" x2="3.01" y2="18" strokeWidth="2" strokeLinecap="round" /></svg>;
    const IconShuffle = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" /></svg>;
    const IconFlip = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;
    const IconUser = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2M12 11a4 4 0 100-8 4 4 0 000 8z" /></svg>;

    const StatusDot = ({ status }) => <span className={`inline-block w-2.5 h-2.5 rounded-full flex-shrink-0 mt-1 ${getStatusColor(status)}`} />;

    // â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const LoginScreen = ({ onLogin }) => {
      const [name, setName] = useState('');
      const [users, setUsersState] = useState(() => loadUsers());

      useEffect(() => {
        syncCloudUsers().then(cloud => {
          if (cloud && Object.keys(cloud).length > 0) {
            setUsersState(prev => { const m = { ...prev, ...cloud }; saveUsers(m); return m; });
          }
        });
      }, []);

      const existingNames = Object.keys(users);

      const login = (n) => { if (!n.trim()) return; saveCurrent(n.trim()); onLogin(n.trim()); };
      const deleteUser = (n) => {
        if (!confirm(`××—×§ ××ª ×”××©×ª××© "${n}" ×•×›×œ ×”× ×ª×•× ×™× ×©×œ×•?`)) return;
        const updated = { ...users };
        delete updated[n];
        saveUsers(updated);
        setUsersState(updated);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-700 flex flex-col items-center justify-center p-6">
          <div className="w-full max-w-sm">
            <div className="text-center mb-8">
              <div className="text-6xl mb-3">ğŸŒ¿</div>
              <h1 className="text-3xl font-black text-white">Sustainability</h1>
              <p className="text-blue-200 mt-1">××™ ××ª×”?</p>
            </div>

            {/* Existing users */}
            {existingNames.length > 0 && (
              <div className="mb-6">
                <p className="text-blue-200 text-sm font-semibold mb-3 text-center">×‘×—×¨ ××©×ª××© ×§×™×™×</p>
                <div className="flex flex-col gap-2">
                  {existingNames.map(n => {
                    const s = users[n]?.statuses || {};
                    const red = Object.values(s).filter(v => v === 'red').length;
                    const yellow = Object.values(s).filter(v => v === 'yellow').length;
                    const green = Object.values(s).filter(v => v === 'green').length;
                    return (
                      <div key={n} className="flex items-center gap-2">
                        <button onClick={() => login(n)}
                          className="flex-1 bg-white/15 hover:bg-white/25 text-white rounded-2xl px-4 py-3 text-left font-bold transition-all active:scale-95 flex items-center justify-between">
                          <span className="flex items-center gap-2"><IconUser />{n}</span>
                          <span className="text-xs text-blue-200 flex gap-2">
                            {red > 0 && <span>ğŸ”´{red}</span>}
                            {yellow > 0 && <span>ğŸŸ¡{yellow}</span>}
                            {green > 0 && <span>ğŸŸ¢{green}</span>}
                          </span>
                        </button>
                        <button onClick={() => deleteUser(n)} className="text-white/40 hover:text-red-300 text-xl px-2 transition-colors">Ã—</button>
                      </div>
                    );
                  })}
                </div>
                <div className="flex items-center gap-3 my-5">
                  <div className="flex-1 h-px bg-white/20" /><span className="text-blue-200 text-xs">××•</span><div className="flex-1 h-px bg-white/20" />
                </div>
              </div>
            )}

            {/* New user */}
            <div className="flex flex-col gap-3">
              <p className="text-blue-200 text-sm font-semibold text-center">××©×ª××© ×—×“×©</p>
              <input
                value={name} onChange={e => setName(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && login(name)}
                placeholder="×”×›× ×¡ ×©×..."
                className="w-full px-5 py-4 rounded-2xl text-slate-800 text-lg font-semibold outline-none shadow-lg text-right"
                dir="auto"
              />
              <button onClick={() => login(name)} disabled={!name.trim()}
                className="w-full py-4 rounded-2xl bg-white text-blue-600 font-black text-lg shadow-lg active:scale-95 transition-all disabled:opacity-40">
                ×”×ª×—×œ ×œ×œ××•×“ ğŸš€
              </button>
            </div>
          </div>
        </div>
      );
    };

    // â”€â”€ Filter tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FilterBar = ({ filter, setFilter, counts }) => {
      const tabs = [
        { key: 'all', label: '×”×›×œ', emoji: 'ğŸ“š', color: 'bg-blue-600 text-white', inactive: 'bg-white text-slate-600 border border-slate-200' },
        { key: 'red', label: '××“×•×', emoji: 'ğŸ”´', color: 'bg-red-500 text-white', inactive: 'bg-white text-red-500 border border-red-200' },
        { key: 'yellow', label: '×¦×”×•×‘', emoji: 'ğŸŸ¡', color: 'bg-amber-400 text-white', inactive: 'bg-white text-amber-600 border border-amber-200' },
        { key: 'green', label: '×™×“×•×¢', emoji: 'ğŸŸ¢', color: 'bg-green-500 text-white', inactive: 'bg-white text-green-600 border border-green-200' },
      ];
      return (
        <div className="flex gap-2 overflow-x-auto pb-1 no-select">
          {tabs.map(t => (
            <button key={t.key} onClick={() => setFilter(t.key)}
              className={`flex-shrink-0 px-3 py-1.5 rounded-full text-sm font-semibold transition-all ${filter === t.key ? t.color : t.inactive}`}>
              {t.emoji} {t.label} <span className="ml-1 opacity-75">({counts[t.key] ?? 0})</span>
            </button>
          ))}
        </div>
      );
    };

    // â”€â”€ Confidence buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ConfidenceButtons = ({ status, onSet }) => (
      <div className="flex gap-3 justify-center no-select">
        {[['red', 'ğŸ”´', '×œ× ×™×•×“×¢'], ['yellow', 'ğŸŸ¡', '×›××¢×˜'], ['green', 'ğŸŸ¢', '×™×•×“×¢!']].map(([s, emoji, label]) => (
          <button key={s} onClick={() => onSet(s)}
            className={`flex-1 py-3 rounded-2xl text-sm font-bold transition-all active:scale-95 border-2 ${status === s
              ? s === 'red' ? 'bg-red-500 text-white border-red-500 shadow-md' : s === 'yellow' ? 'bg-amber-400 text-white border-amber-400 shadow-md' : 'bg-green-500 text-white border-green-500 shadow-md'
              : 'bg-white text-slate-600 border-slate-200'
              }`}>
            <div className="text-xl">{emoji}</div>
            <div className="text-xs">{label}</div>
          </button>
        ))}
      </div>
    );

    // â”€â”€ FLASHCARDS MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FlashcardsMode = ({ cards, statuses, setStatus }) => {
      const [idx, setIdx] = useState(0);
      const [flipped, setFlipped] = useState(false);
      const [shuffled, setShuffled] = useState(false);
      const [deck, setDeck] = useState(cards);
      const [touchStartX, setTouchStartX] = useState(null);

      useEffect(() => { setDeck(shuffled ? shuffle(cards) : cards); setIdx(0); setFlipped(false); }, [cards, shuffled]);

      const go = dir => { setFlipped(false); setTimeout(() => setIdx(i => dir === 'next' ? Math.min(i + 1, deck.length - 1) : Math.max(i - 1, 0)), 120); };

      const onTouchStart = e => setTouchStartX(e.touches[0].clientX);
      const onTouchEnd = e => {
        if (touchStartX === null) return;
        const diff = touchStartX - e.changedTouches[0].clientX;
        if (diff > 50 && idx < deck.length - 1) go('next'); // Swipe left -> Next
        else if (diff < -50 && idx > 0) go('prev'); // Swipe right -> Prev
        setTouchStartX(null);
      };

      if (!deck.length) return <div className="flex flex-col items-center justify-center h-64 text-slate-400"><div className="text-5xl mb-4">ğŸ˜´</div><p className="text-lg font-medium">××™×Ÿ ×›×¨×˜×™×¡×™× ×‘×¤×™×œ×˜×¨ ×–×”</p></div>;

      const card = deck[idx];
      const cardStatus = statuses[card.id] || 'unmarked';
      const allOptions = useMemo(() => {
        if (!card.correct_answer && !card.wrong_answers?.length) return [];
        const options = [card.correct_answer, ...(card.wrong_answers || [])].filter(Boolean);
        return shuffle(options);
      }, [card]);

      return (
        <div className="flex flex-col gap-5">
          <div className="flex items-center gap-3">
            <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
              <div className="h-full bg-blue-500 rounded-full transition-all" style={{ width: `${((idx + 1) / deck.length) * 100}%` }} />
            </div>
            <span className="text-sm font-semibold text-slate-500 shrink-0">{idx + 1} / {deck.length}</span>
            <button onClick={() => setShuffled(s => !s)}
              className={`p-2 rounded-xl border transition-all ${shuffled ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200'}`}>
              <IconShuffle />
            </button>
          </div>

          <div className="card-container w-full" style={{ height: '65vh', minHeight: '400px' }} onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
            <div className={`card-inner w-full h-full ${flipped ? 'flipped' : ''}`} onClick={() => setFlipped(f => !f)}>
              <div className={`card-face bg-white shadow-xl border-2 ${getStatusBorder(cardStatus)} flex flex-col p-6 cursor-pointer overflow-y-auto`}>
                <div className="m-auto flex flex-col items-center w-full">
                  <div className="text-xs font-bold text-blue-400 uppercase tracking-widest mb-4 shrink-0 mt-2">×©××œ×”</div>
                  <p className="text-center text-slate-800 font-bold text-xl md:text-2xl leading-snug mb-6 w-full">{card.question}</p>
                  {allOptions.length > 0 && (
                    <div className="w-full flex flex-col gap-3 mb-8 w-full">
                      {allOptions.map((a, i) => (
                        <div key={i} className="text-left px-4 py-3 rounded-xl border-2 text-sm md:text-base font-medium leading-snug border-slate-200 bg-slate-50 text-slate-700 w-full">
                          <span className="mr-2 font-bold text-slate-400">{String.fromCharCode(65 + i)}.</span>{a}
                        </div>
                      ))}
                    </div>
                  )}
                  <div className="mt-auto pt-4 pb-2 text-slate-400 text-xs flex justify-center items-center gap-1 w-full shrink-0"><IconFlip /><span>×œ×—×¥ ×œ×”×¤×•×š</span></div>
                </div>
              </div>
              <div className={`card-face card-back bg-blue-600 shadow-xl flex flex-col p-6 cursor-pointer overflow-y-auto`}>
                <div className="m-auto flex flex-col items-center w-full">
                  <div className="text-xs font-bold text-blue-200 uppercase tracking-widest mb-3 shrink-0 mt-2">×ª×©×•×‘×” × ×›×•× ×”</div>
                  <p className="text-center text-white font-semibold text-lg leading-snug w-full">{card.correct_answer || '(××™×Ÿ ×ª×©×•×‘×”)'}</p>
                  {card.wrong_answers?.length > 0 && (
                    <div className="mt-4 w-full">
                      <div className="text-xs text-blue-300 mb-1 font-medium">××¤×©×¨×•×™×•×ª ×©×’×•×™×•×ª:</div>
                      {card.wrong_answers.slice(0, 3).map((a, i) => <div key={i} className="text-blue-200 text-xs leading-snug">â€¢ {a}</div>)}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>

          <ConfidenceButtons status={cardStatus} onSet={s => setStatus(card.id, s)} />

          <div className="flex gap-3">
            <button onClick={() => go('prev')} disabled={idx === 0} className="flex-1 py-4 rounded-2xl font-bold text-slate-600 bg-white border border-slate-200 disabled:opacity-30 active:scale-95 transition-all text-lg">â† ×”×§×•×“×</button>
            <button onClick={() => go('next')} disabled={idx === deck.length - 1} className="flex-1 py-4 rounded-2xl font-bold text-white bg-blue-600 disabled:opacity-30 active:scale-95 transition-all shadow-md text-lg">×”×‘× â†’</button>
          </div>
        </div>
      );
    };

    // â”€â”€ TEST MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const buildQuiz = (cards, allCards, count) => {
      const allAnswers = allCards.map(c => c.correct_answer).filter(Boolean);
      return shuffle(cards).slice(0, Math.min(count, cards.length)).map(card => {
        const correct = card.correct_answer;
        const wrongs = shuffle([...(card.wrong_answers || []), ...allAnswers.filter(a => a !== correct)]).slice(0, 3);
        return { id: card.id, question: card.question, correct, options: shuffle([correct, ...wrongs]) };
      });
    };

    const TestMode = ({ cards, allCards, filter }) => {
      const [quiz, setQuiz] = useState(null);
      const [answers, setAnswers] = useState({});
      const [submitted, setSubmitted] = useState(false);
      const [shakeSubmit, setShakeSubmit] = useState(false);
      const [count, setCount] = useState(20);

      useEffect(() => { setQuiz(null); setAnswers({}); setSubmitted(false); }, [cards]);

      const startQuiz = () => { setQuiz(buildQuiz(cards, allCards, count)); setAnswers({}); setSubmitted(false); };
      const pick = (qid, opt) => { if (submitted) return; setAnswers(a => ({ ...a, [qid]: opt })); };
      const submit = () => {
        if (quiz.some(q => !answers[q.id])) { setShakeSubmit(true); setTimeout(() => setShakeSubmit(false), 500); return; }
        setSubmitted(true); window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      if (!cards.length) return (
        <div className="flex flex-col items-center justify-center h-64 text-slate-400">
          <div className="text-5xl mb-4">ğŸš«</div>
          <p className="font-medium">××™×Ÿ ×›×¨×˜×™×¡×™× ×‘×¤×™×œ×˜×¨ ×–×”</p>
          <p className="text-sm mt-1">×©× ×” ×¤×™×œ×˜×¨ ×œ××¢×œ×”</p>
        </div>
      );

      if (!quiz) {
        const filterLabel = { all: '×›×œ ×”×©××œ×•×ª', red: 'ğŸ”´ ×©××œ×•×ª ××“×•××•×ª', yellow: 'ğŸŸ¡ ×©××œ×•×ª ×¦×”×•×‘×•×ª', green: 'ğŸŸ¢ ×©××œ×•×ª ×™×¨×•×§×•×ª' }[filter];
        return (
          <div className="flex flex-col items-center gap-5 py-8">
            <div className="text-6xl">ğŸ“</div>
            <div className="text-center">
              <h2 className="text-2xl font-bold text-slate-800">××‘×—×Ÿ</h2>
              <p className="text-slate-500 mt-1">{filterLabel} â€¢ {cards.length} ×–××™× ×•×ª</p>
            </div>
            {/* Count selector */}
            <div className="w-full bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
              <p className="text-slate-600 font-semibold text-sm mb-3 text-center">×›××” ×©××œ×•×ª?</p>
              <div className="flex gap-2 flex-wrap justify-center">
                {[10, 20, 30, 50, cards.length].filter((v, i, arr) => arr.indexOf(v) === i && v <= cards.length).map(n => (
                  <button key={n} onClick={() => setCount(n)}
                    className={`px-4 py-2 rounded-xl font-bold text-sm transition-all ${count === n ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'}`}>
                    {n === cards.length ? `×›×œ (${n})` : n}
                  </button>
                ))}
              </div>
            </div>
            <div className="w-full bg-amber-50 border border-amber-200 rounded-2xl p-3 text-sm text-amber-800">
              ğŸ’¡ <strong>×˜×™×¤:</strong> ×©× ×” ××ª ×”×¤×™×œ×˜×¨ ×œ××¢×œ×” ×œ×ª×¨×’×•×œ ×××•×§×“ â€” ×œ××©×œ "ğŸ”´ ××“×•×" ×œ××‘×—×Ÿ ×¨×§ ×¢×œ ××” ×©×œ× ×™×“×¢×ª
            </div>
            <button onClick={startQuiz} className="w-full py-4 rounded-2xl bg-blue-600 text-white font-black text-lg shadow-lg active:scale-95 transition-all">
              ×”×ª×—×œ ××‘×—×Ÿ ğŸš€
            </button>
          </div>
        );
      }

      if (submitted) {
        const score = quiz.filter(q => answers[q.id] === q.correct).length;
        const pct = Math.round((score / quiz.length) * 100);
        const emoji = pct >= 80 ? 'ğŸ‰' : pct >= 50 ? 'ğŸ’ª' : 'ğŸ˜…';
        return (
          <div className="flex flex-col gap-4">
            <div className={`rounded-2xl p-6 text-center text-white shadow-lg ${pct >= 80 ? 'bg-green-500' : pct >= 50 ? 'bg-amber-400' : 'bg-red-500'}`}>
              <div className="text-5xl mb-2">{emoji}</div>
              <div className="text-4xl font-black">{pct}%</div>
              <div className="text-lg opacity-90">{score} / {quiz.length} × ×›×•×Ÿ</div>
            </div>
            <button onClick={startQuiz} className="w-full py-4 rounded-2xl bg-blue-600 text-white font-bold text-lg shadow-md active:scale-95 transition-all">× ×¡×” ×©×•×‘ ğŸ”„</button>
            <div className="flex flex-col gap-3">
              {quiz.map((q, i) => {
                const correct = answers[q.id] === q.correct;
                return (
                  <div key={q.id} className={`rounded-2xl p-4 border-2 ${correct ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}`}>
                    <div className="text-xs font-bold uppercase tracking-wide mb-1 text-slate-500">×©{i + 1}</div>
                    <p className="font-semibold text-slate-800 text-sm mb-2 leading-snug">{q.question}</p>
                    {!correct && <div className="text-red-600 text-sm mb-1">âŒ ×¢× ×™×ª: <span className="font-medium">{answers[q.id]}</span></div>}
                    <div className="text-green-700 text-sm">âœ… × ×›×•×Ÿ: <span className="font-medium">{q.correct}</span></div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col gap-4">
          {/* Progress */}
          <div className="flex items-center gap-3">
            <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
              <div className="h-full bg-blue-500 rounded-full transition-all" style={{ width: `${(Object.keys(answers).length / quiz.length) * 100}%` }} />
            </div>
            <span className="text-sm font-semibold text-slate-500 shrink-0">{Object.keys(answers).length}/{quiz.length}</span>
          </div>
          {quiz.map((q, i) => (
            <div key={q.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
              <div className="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2">×©{i + 1}</div>
              <p className="font-semibold text-slate-800 mb-4 leading-snug text-sm">{q.question}</p>
              <div className="flex flex-col gap-2">
                {q.options.map((opt, j) => (
                  <button key={j} onClick={() => pick(q.id, opt)}
                    className={`text-left px-4 py-3 rounded-xl border-2 text-sm font-medium transition-all active:scale-95 leading-snug ${answers[q.id] === opt ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 bg-slate-50 text-slate-700'
                      }`}>
                    <span className="mr-2 font-bold text-slate-400">{String.fromCharCode(65 + j)}.</span>{opt}
                  </button>
                ))}
              </div>
            </div>
          ))}
          <button onClick={submit} className={`w-full py-4 rounded-2xl font-bold text-lg transition-all active:scale-95 shadow-lg bg-blue-600 text-white ${shakeSubmit ? 'shake' : ''}`}>
            ×”×’×© ××‘×—×Ÿ âœ“
          </button>
        </div>
      );
    };

    // â”€â”€ LIST MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ListMode = ({ cards, statuses }) => {
      const [search, setSearch] = useState('');
      const [hideCorrect, setHideCorrect] = useState(false);
      const [revealed, setRevealed] = useState({});

      // Reset revealed when toggling hide mode
      const toggleHide = () => { setHideCorrect(h => !h); setRevealed({}); };
      const revealCard = id => setRevealed(r => ({ ...r, [id]: true }));

      const filtered = cards.filter(c =>
        !search || c.question.toLowerCase().includes(search.toLowerCase()) || c.correct_answer?.toLowerCase().includes(search.toLowerCase())
      );

      return (
        <div className="flex flex-col gap-3">
          {/* Controls row */}
          <div className="flex gap-2">
            <input value={search} onChange={e => setSearch(e.target.value)} placeholder="ğŸ” ×—×™×¤×•×©..."
              className="flex-1 px-4 py-3 rounded-2xl border border-slate-200 bg-white text-slate-800 outline-none focus:border-blue-400 transition-all"
              dir="auto" />
            <button onClick={toggleHide}
              className={`shrink-0 px-4 py-3 rounded-2xl font-bold text-sm transition-all border-2 active:scale-95 ${hideCorrect ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'
                }`}>
              {hideCorrect ? 'ğŸ™ˆ ××•×¡×ª×¨' : 'ğŸ‘ ×’×œ×•×™'}
            </button>
          </div>

          {hideCorrect && (
            <div className="bg-blue-50 border border-blue-200 rounded-xl px-4 py-2 text-blue-700 text-xs font-medium">
              ğŸ’¡ ×›×œ ×”××¤×©×¨×•×™×•×ª ××•×¦×’×•×ª â€” ×œ×—×¥ ×¢×œ "×’×œ×”" ×›×“×™ ×œ×¨××•×ª ××” × ×›×•×Ÿ
            </div>
          )}

          <div className="flex flex-col gap-3">
            {filtered.map(card => {
              const s = statuses[card.id] || 'unmarked';
              const isRevealed = revealed[card.id];
              const allOptions = shuffle([...(card.wrong_answers || []), card.correct_answer].filter(Boolean));

              return (
                <div key={card.id} className={`bg-white rounded-2xl p-4 shadow-sm border-l-4 status-${s}`}>
                  <div className="flex items-start gap-2">
                    <StatusDot status={s} />
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-slate-800 text-sm leading-snug">{card.question}</p>

                      {hideCorrect && !isRevealed ? (
                        /* Hidden mode: show all options without marking correct */
                        <div className="mt-3">
                          <div className="flex flex-col gap-1.5 mb-3">
                            {allOptions.map((opt, i) => (
                              <div key={i} className="flex items-start gap-2 text-sm text-slate-600 bg-slate-50 rounded-xl px-3 py-2">
                                <span className="font-bold text-slate-400 shrink-0">{String.fromCharCode(65 + i)}.</span>
                                <span className="leading-snug">{opt}</span>
                              </div>
                            ))}
                          </div>
                          <button onClick={() => revealCard(card.id)}
                            className="w-full py-2.5 rounded-xl bg-blue-600 text-white text-sm font-bold active:scale-95 transition-all">
                            ×’×œ×” ×ª×©×•×‘×” âœ“
                          </button>
                        </div>
                      ) : (
                        /* Visible mode (or after reveal): mark correct/wrong */
                        <div className="mt-2 flex flex-col gap-1">
                          <div className="flex items-start gap-2 bg-green-50 rounded-xl px-3 py-2">
                            <span className="text-green-500 shrink-0">âœ…</span>
                            <span className="text-green-700 font-medium text-sm leading-snug">{card.correct_answer || 'â€”'}</span>
                          </div>
                          {card.wrong_answers?.map((a, i) => (
                            <div key={i} className="flex items-start gap-2 bg-red-50 rounded-xl px-3 py-2">
                              <span className="text-red-400 shrink-0">âœ—</span>
                              <span className="text-red-500 text-xs leading-snug">{a}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
            {!filtered.length && <div className="text-center text-slate-400 py-10">×œ× × ××¦××• ×ª×•×¦××•×ª</div>}
          </div>
        </div>
      );
    };

    // â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const App = () => {
      const [currentUser, setCurrentUser] = useState(() => loadCurrent());
      const [users, setUsers] = useState(() => loadUsers());
      const [allCards] = useState(() => loadData());
      const [filter, setFilter] = useState('all');
      const [mode, setMode] = useState('flashcards');

      const [showNav, setShowNav] = useState(true);
      const lastScroll = useRef(0);

      useEffect(() => {
        const handleScroll = () => {
          const currentScroll = window.scrollY;

          // Prevent running on iOS rubber-band overscroll
          if (currentScroll < 0) return;
          if (currentScroll + window.innerHeight >= document.documentElement.scrollHeight) return;

          if (currentScroll > lastScroll.current && currentScroll > 50) {
            setShowNav(false);
          } else {
            setShowNav(true);
          }
          lastScroll.current = currentScroll;
        };
        window.addEventListener('scroll', handleScroll, { passive: true });
        return () => window.removeEventListener('scroll', handleScroll);
      }, []);

      useEffect(() => {
        syncCloudUsers().then(cloud => {
          if (cloud && Object.keys(cloud).length > 0) {
            setUsers(prev => { const m = { ...prev, ...cloud }; saveUsers(m); return m; });
          }
        });
      }, []);

      // statuses for the current user
      const statuses = currentUser ? getUserStatuses(users, currentUser) : {};

      const setStatus = useCallback((id, status) => {
        if (!currentUser) return;
        setUsers(prev => {
          const newStatuses = { ...getUserStatuses(prev, currentUser), [id]: status };
          const updated = setUserStatuses(prev, currentUser, newStatuses);
          saveUsers(updated);
          pushCloudUser(currentUser, newStatuses);
          return updated;
        });
      }, [currentUser]);

      const handleLogin = name => { setCurrentUser(name); };
      const handleLogout = () => {
        clearCurrent();
        setCurrentUser(null);
        setFilter('all');
        setMode('flashcards');
      };

      const resetUser = () => {
        if (!confirm('××™×¤×•×¡ ×›×œ ×”×¡×™××•× ×™× ×©×œ×š?')) return;
        setUsers(prev => {
          const updated = setUserStatuses(prev, currentUser, {});
          saveUsers(updated);
          pushCloudUser(currentUser, {});
          return updated;
        });
      };

      const counts = useMemo(() => ({
        all: allCards.length,
        red: allCards.filter(c => statuses[c.id] === 'red').length,
        yellow: allCards.filter(c => statuses[c.id] === 'yellow').length,
        green: allCards.filter(c => statuses[c.id] === 'green').length,
      }), [allCards, statuses]);

      const filteredCards = useMemo(() => {
        if (filter === 'all') return allCards;
        return allCards.filter(c => (statuses[c.id] || 'unmarked') === filter);
      }, [allCards, statuses, filter]);

      useEffect(() => {
        if (filter !== 'all' && filteredCards.length === 0) {
          setFilter('all');
        }
      }, [filter, filteredCards.length]);

      if (!currentUser) return <LoginScreen onLogin={handleLogin} />;

      const tabs = [
        { key: 'flashcards', label: '×›×¨×˜×™×¡×™×', icon: <IconCards /> },
        { key: 'test', label: '××‘×—×Ÿ', icon: <IconTest /> },
        { key: 'list', label: '×¨×©×™××”', icon: <IconList /> },
      ];

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-100 to-blue-50">
          {/* Header */}
          <div className={`fixed top-0 left-0 right-0 z-30 bg-white/95 backdrop-blur border-b border-slate-100 shadow-sm transition-transform duration-300 ${showNav ? 'translate-y-0' : '-translate-y-full'}`}>
            <div className="max-w-lg mx-auto px-4 pt-3 pb-3 flex flex-col gap-3">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-xl font-black text-slate-800">ğŸŒ¿ Sustainability</h1>
                  <p className="text-xs text-slate-400">{allCards.length} ×©××œ×•×ª</p>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={handleLogout}
                    className="flex items-center gap-1.5 text-xs text-slate-500 bg-slate-100 hover:bg-slate-200 px-3 py-1.5 rounded-xl transition-all font-semibold">
                    <IconUser />{currentUser}
                  </button>
                  <button onClick={resetUser} className="text-xs text-slate-400 bg-slate-100 px-3 py-1.5 rounded-xl">××™×¤×•×¡</button>
                </div>
              </div>
              <FilterBar filter={filter} setFilter={setFilter} counts={counts} />
            </div>
          </div>

          <div className="max-w-lg mx-auto px-4 pt-44">
            {/* Mode tabs */}
            <div className="flex bg-white rounded-2xl p-1 shadow-sm border border-slate-100 mb-5">
              {tabs.map(t => (
                <button key={t.key} onClick={() => setMode(t.key)}
                  className={`flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl text-sm font-bold transition-all ${mode === t.key ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500'
                    }`}>
                  {t.icon}<span>{t.label}</span>
                </button>
              ))}
            </div>

            <div className="pb-10">
              {mode === 'flashcards' && <FlashcardsMode cards={filteredCards} statuses={statuses} setStatus={setStatus} />}
              {mode === 'test' && <TestMode cards={filteredCards} allCards={allCards} filter={filter} />}
              {mode === 'list' && <ListMode cards={filteredCards} statuses={statuses} />}
            </div>
          </div>
        </div >
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
  <script>window.__QUIZ_DATA__ = null;</script>
  <script src="quiz_data.js"></script>
</body>

</html>