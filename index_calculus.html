<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hedva Formulas - ×—×“×•×´× 2</title>
  <meta name="description" content="××¤×œ×™×§×¦×™×™×ª ×œ×™××•×“ × ×•×¡×—××•×ª ×—×“×•×´× 2 ×¢× ×›×¨×˜×™×¡×™×•×ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª ×•××‘×—× ×™×">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#667eea">
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Hedva Formulas">
  <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-192x192.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-72x72.png">
  <link rel="shortcut icon" href="/icons/icon-72x72.png">
  
  <!-- MS Tile -->
  <meta name="msapplication-TileColor" content="#667eea">
  <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
  
  <!-- Build: 2026-02-27-calculus-pwa -->
  
  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- KaTeX CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overscroll-behavior: none;
    }

    .card-container {
      perspective: 1000px;
    }

    .card-inner {
      transition: transform 0.55s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
      position: relative;
    }

    .card-inner.flipped {
      transform: rotateY(180deg);
    }

    .card-face {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      position: absolute;
      inset: 0;
      border-radius: 1.5rem;
      overflow-y: auto;
    }

    .card-back {
      transform: rotateY(180deg);
    }

    .status-unmarked {
      border-left: 4px solid #cbd5e1;
    }

    .status-red {
      border-left: 4px solid #ef4444;
    }

    .status-yellow {
      border-left: 4px solid #f59e0b;
    }

    .status-green {
      border-left: 4px solid #10b981;
    }

    .no-select {
      user-select: none;
      -webkit-user-select: none;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #a78bfa;
      border-radius: 4px;
    }

    .shake {
      animation: shake 0.4s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0) }
      25% { transform: translateX(-8px) }
      75% { transform: translateX(8px) }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* KaTeX styling */
    .katex-display {
      margin: 0;
      text-align: center;
    }

    .math-display {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      min-height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .math-option {
      min-height: 3.5rem;
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
    }

    /* Gradient background */
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gradient-card {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    /* Force LTR for LaTeX formulas while keeping Hebrew RTL */
    .katex,
    .katex-display,
    .katex-html,
    .katex *,
    .math-display,
    .math-option {
      direction: ltr !important;
      text-align: left !important;
    }

    /* Ensure mathematical content displays LTR */
    [class*="math"],
    [class*="katex"] {
      direction: ltr !important;
      unicode-bidi: embed;
    }

    /* Numbers and mathematical symbols should be LTR */
    .card-face {
      unicode-bidi: plaintext;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // â”€â”€ Math Display Component (KaTeX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const MathDisplay = ({ latex, displayMode = true, className = "" }) => {
      const containerRef = useRef(null);
      
      useEffect(() => {
        if (containerRef.current && window.katex && latex) {
          try {
            window.katex.render(latex, containerRef.current, {
              displayMode: displayMode,
              throwOnError: false,
              errorColor: '#ef4444',
              trust: false
            });
          } catch (e) {
            console.error('KaTeX render error:', e);
            containerRef.current.innerHTML = `<span style="color: #ef4444;">× ×•×¡×—×” ×©×’×•×™×”</span>`;
          }
        }
      }, [latex, displayMode]);
      
      return <div ref={containerRef} className={className} />;
    };

    // â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const loadData = () => {
      const raw = window.__QUIZ_DATA__;
      if (!raw) return [];
      return raw.filter(q => q.name && q.formula).map(q => ({ ...q, status: 'unmarked' }));
    };

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
    const getStatusColor = s => ({ 
      unmarked: 'bg-slate-400', 
      red: 'bg-red-500', 
      yellow: 'bg-amber-400', 
      green: 'bg-emerald-500' 
    }[s] || 'bg-slate-400');
    
    const getStatusBorder = s => ({ 
      unmarked: 'border-slate-300', 
      red: 'border-red-400', 
      yellow: 'border-amber-400', 
      green: 'border-emerald-400' 
    }[s] || 'border-slate-300');

    // â”€â”€ User Profile Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const USERS_KEY = 'calculus_users_v1';
    const CURRENT_USER_KEY = 'calculus_current_user';
    const HIGHSCORE_KEY = 'calculus_highscore_v1';
    
    const loadUsers = () => { 
      try { return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); } 
      catch { return {}; } 
    };
    
    const saveUsers = data => localStorage.setItem(USERS_KEY, JSON.stringify(data));
    const loadCurrent = () => localStorage.getItem(CURRENT_USER_KEY) || null;
    const saveCurrent = name => localStorage.setItem(CURRENT_USER_KEY, name);
    const clearCurrent = () => localStorage.removeItem(CURRENT_USER_KEY);
    
    const getUserData = (users, name) => users[name] || { statuses: {}, highScore: 0, quizzesTaken: 0 };
    const setUserData = (users, name, data) => ({ 
      ...users, 
      [name]: { ...getUserData(users, name), ...data, name } 
    });

    // â”€â”€ Cloud Sync Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const isLocalFile = () => window.location.protocol === 'file:';
    
    const syncCloudUsers = async () => { 
      if (isLocalFile()) return null;
      try { 
        const r = await fetch('/api/users'); 
        if (r.ok) {
          const data = await r.json();
          // Backend now returns data directly without course nesting
          return data;
        }
      } catch (e) { 
        console.log('Cloud sync unavailable:', e);
      } 
      return null; 
    };
    
    const pushCloudUser = async (name, data) => { 
      if (isLocalFile()) return;
      try { 
        await fetch('/api/users', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ 
            action: 'sync',
            name, 
            ...data 
          }) 
        }); 
      } catch (e) {
        console.log('Cloud push failed:', e);
      } 
    };

    // â”€â”€ Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const IconCards = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="3" strokeWidth="2" /><line x1="8" y1="4" x2="8" y2="20" strokeWidth="2" /></svg>;
    const IconTest = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>;
    const IconList = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6" strokeWidth="2" /><line x1="8" y1="12" x2="21" y2="12" strokeWidth="2" /><line x1="8" y1="18" x2="21" y2="18" strokeWidth="2" /><line x1="3" y1="6" x2="3.01" y2="6" strokeWidth="2" strokeLinecap="round" /><line x1="3" y1="12" x2="3.01" y2="12" strokeWidth="2" strokeLinecap="round" /><line x1="3" y1="18" x2="3.01" y2="18" strokeWidth="2" strokeLinecap="round" /></svg>;
    const IconShuffle = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" /></svg>;
    const IconFlip = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;
    const IconUser = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2M12 11a4 4 0 100-8 4 4 0 000 8z" /></svg>;

    const StatusDot = ({ status }) => <span className={`inline-block w-2.5 h-2.5 rounded-full flex-shrink-0 mt-1 ${getStatusColor(status)}`} />;

    // â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const LoginScreen = ({ onLogin }) => {
      const [name, setName] = useState('');
      const [pin, setPin] = useState('');
      const [isCreating, setIsCreating] = useState(false);
      const [users, setUsersState] = useState(() => loadUsers());
      const [error, setError] = useState('');

      useEffect(() => {
        syncCloudUsers().then(cloud => {
          if (cloud && Object.keys(cloud).length > 0) {
            setUsersState(prev => { 
              const m = { ...prev, ...cloud }; 
              saveUsers(m); 
              return m; 
            });
          }
        });
      }, []);

      const existingNames = Object.keys(users);

      const handleLogin = async () => {
        if (!name.trim()) {
          setError('×”×›× ×¡ ×©× ××©×ª××©');
          return;
        }
        
        setError(''); // Clear previous errors
        
        if (isCreating) {
          // Create new account
          if (!pin.trim() || pin.length < 4) {
            setError('×”×›× ×¡ PIN ×‘×Ÿ 4 ×¡×¤×¨×•×ª ×œ×¤×—×•×ª');
            return;
          }
          if (users[name.trim()]) {
            setError('××©×ª××© ×§×™×™× ×›×‘×¨, ×”×ª×—×‘×¨ ××• ×‘×—×¨ ×©× ××—×¨');
            return;
          }
          
          // Register with cloud first
          if (!isLocalFile()) {
            try {
              const response = await fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  action: 'register',
                  name: name.trim(),
                  pin: pin
                })
              });
              
              const result = await response.json();
              
              if (!response.ok) {
                setError(result.error || '×©×’×™××” ×‘×™×¦×™×¨×ª ××©×ª××©');
                return;
              }
              
              // Save to local storage
              const newUserData = {
                name: name.trim(),
                pin: pin,
                statuses: result.user.statuses || {},
                highScore: result.user.highScore || 0,
                quizzesTaken: result.user.quizzesTaken || 0
              };
              const newUsers = setUserData(users, name.trim(), newUserData);
              saveUsers(newUsers);
              setUsersState(newUsers);
              saveCurrent(name.trim());
              onLogin(name.trim());
            } catch (e) {
              console.error('Registration failed:', e);
              setError('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª');
            }
          } else {
            // Local file mode - save locally only
            const newUsers = setUserData(users, name.trim(), { pin, statuses: {}, highScore: 0, quizzesTaken: 0 });
            saveUsers(newUsers);
            setUsersState(newUsers);
            saveCurrent(name.trim());
            onLogin(name.trim());
          }
        } else {
          // Login existing
          
          // Try cloud login first
          if (!isLocalFile()) {
            try {
              const response = await fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  action: 'login',
                  name: name.trim(),
                  pin: pin
                })
              });
              
              const result = await response.json();
              
              if (!response.ok) {
                // If user not found in cloud, try local
                const userData = users[name.trim()];
                if (!userData) {
                  setError('××©×ª××© ×œ× × ××¦×');
                  return;
                }
                if (userData.pin && userData.pin !== pin) {
                  setError('PIN ×©×’×•×™');
                  return;
                }
                saveCurrent(name.trim());
                onLogin(name.trim());
                return;
              }
              
              // Save cloud data to local storage
              const userData = {
                name: result.user.name,
                pin: pin,
                statuses: result.user.statuses || {},
                highScore: result.user.highScore || 0,
                quizzesTaken: result.user.quizzesTaken || 0
              };
              const updatedUsers = setUserData(users, name.trim(), userData);
              saveUsers(updatedUsers);
              setUsersState(updatedUsers);
              saveCurrent(name.trim());
              onLogin(name.trim());
            } catch (e) {
              console.error('Cloud login failed:', e);
              // Fallback to local login
              const userData = users[name.trim()];
              if (!userData) {
                setError('××©×ª××© ×œ× × ××¦×');
                return;
              }
              if (userData.pin && userData.pin !== pin) {
                setError('PIN ×©×’×•×™');
                return;
              }
              saveCurrent(name.trim());
              onLogin(name.trim());
            }
          } else {
            // Local file mode - login from localStorage
            const userData = users[name.trim()];
            if (!userData) {
              setError('××©×ª××© ×œ× × ××¦×');
              return;
            }
            if (userData.pin && userData.pin !== pin) {
              setError('PIN ×©×’×•×™');
              return;
            }
            saveCurrent(name.trim());
            onLogin(name.trim());
          }
        }
      };

      const quickLogin = (n) => {
        saveCurrent(n);
        onLogin(n);
      };

      return (
        <div className="min-h-screen gradient-bg flex flex-col items-center justify-center p-6">
          <div className="w-full max-w-md">
            <div className="text-center mb-8">
              <div className="text-7xl mb-4">âˆ«</div>
              <h1 className="text-4xl font-black text-white mb-2">Calculus 2</h1>
              <h2 className="text-2xl font-bold text-violet-200">Formulas Pro</h2>
              <p className="text-violet-300 mt-2">×œ××“ 60+ × ×•×¡×—××•×ª ×—×©×•×‘×•×ª</p>
            </div>

            <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20">
              {existingNames.length > 0 && !isCreating && (
                <div className="mb-6">
                  <p className="text-white/90 text-sm font-semibold mb-3 text-center">××©×ª××©×™× ×§×™×™××™×</p>
                  <div className="flex flex-col gap-2 max-h-48 overflow-y-auto">
                    {existingNames.map(n => {
                      const userData = users[n];
                      const s = userData?.statuses || {};
                      const green = Object.values(s).filter(v => v === 'green').length;
                      const highScore = userData?.highScore || 0;
                      return (
                        <button key={n} onClick={() => quickLogin(n)}
                          className="flex items-center justify-between bg-white/15 hover:bg-white/25 text-white rounded-xl px-4 py-3 transition-all active:scale-95">
                          <span className="flex items-center gap-2 font-bold">
                            <IconUser />{n}
                          </span>
                          <span className="text-xs text-violet-200 flex gap-2">
                            {green > 0 && <span>ğŸŸ¢ {green}</span>}
                            {highScore > 0 && <span>ğŸ† {highScore}%</span>}
                          </span>
                        </button>
                      );
                    })}
                  </div>
                  <div className="flex items-center gap-3 my-4">
                    <div className="flex-1 h-px bg-white/20" />
                    <span className="text-white/60 text-xs">××•</span>
                    <div className="flex-1 h-px bg-white/20" />
                  </div>
                </div>
              )}

              <div className="flex flex-col gap-3">
                <p className="text-white/90 text-sm font-semibold text-center">
                  {isCreating ? '×™×¦×™×¨×ª ×—×©×‘×•×Ÿ ×—×“×©' : '×”×ª×—×‘×¨ / ×¦×•×¨ ×—×©×‘×•×Ÿ'}
                </p>
                
                {error && (
                  <div className="bg-red-500/20 border border-red-500/50 text-red-100 px-4 py-2 rounded-xl text-sm text-center">
                    {error}
                  </div>
                )}
                
                <input
                  value={name}
                  onChange={e => { setName(e.target.value); setError(''); }}
                  onKeyDown={e => e.key === 'Enter' && handleLogin()}
                  placeholder="×©× ××©×ª××©"
                  className="w-full px-5 py-4 rounded-xl text-slate-800 text-lg font-semibold outline-none shadow-lg text-center bg-white"
                  dir="auto"
                />
                
                <input
                  type="password"
                  value={pin}
                  onChange={e => { setPin(e.target.value); setError(''); }}
                  onKeyDown={e => e.key === 'Enter' && handleLogin()}
                  placeholder={isCreating ? "×¦×•×¨ PIN (4+ ×¡×¤×¨×•×ª)" : "PIN (××•×¤×¦×™×•× ×œ×™)"}
                  className="w-full px-5 py-4 rounded-xl text-slate-800 text-lg font-semibold outline-none shadow-lg text-center bg-white"
                  dir="ltr"
                />
                
                <button 
                  onClick={handleLogin}
                  disabled={!name.trim()}
                  className="w-full py-4 rounded-xl bg-white text-indigo-600 font-black text-lg shadow-lg active:scale-95 transition-all disabled:opacity-40"
                >
                  {isCreating ? 'ğŸš€ ×¦×•×¨ ×—×©×‘×•×Ÿ' : 'â–¶ï¸ ×”×ª×—×‘×¨'}
                </button>
                
                <button
                  onClick={() => { setIsCreating(!isCreating); setError(''); }}
                  className="text-white/70 hover:text-white text-sm transition-colors"
                >
                  {isCreating ? '×™×© ×œ×š ×—×©×‘×•×Ÿ? ×”×ª×—×‘×¨' : '××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×¦×•×¨ ×—×“×©'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // â”€â”€ Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€ Combined Filter Bar (Chapters + Status in one row) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CombinedFilterBar = ({ 
      filter, setFilter, counts, 
      chapters, selectedChapter, setSelectedChapter, 
      allCards, topicToCategory 
    }) => {
      const chapterCounts = useMemo(() => {
        const chapterCounts = {};
        chapters.forEach(ch => {
          chapterCounts[ch] = allCards.filter(c => (topicToCategory[c.topic] || c.topic) === ch).length;
        });
        return chapterCounts;
      }, [chapters, allCards, topicToCategory]);

      const statusTabs = [
        { key: 'red', emoji: 'ğŸ”´', color: 'bg-red-500 text-white', inactive: 'bg-white/10 text-white border-white/20' },
        { key: 'yellow', emoji: 'ğŸŸ¡', color: 'bg-amber-400 text-white', inactive: 'bg-white/10 text-white border-white/20' },
        { key: 'green', emoji: 'ğŸŸ¢', color: 'bg-emerald-500 text-white', inactive: 'bg-white/10 text-white border-white/20' },
      ];

      return (
        <div className="flex gap-2 overflow-x-auto pb-2 no-select">
          {/* Chapter buttons */}
          <button
            onClick={() => setSelectedChapter('all')}
            className={`flex-shrink-0 px-3 py-1.5 rounded-xl text-xs font-semibold transition-all border-2 ${
              selectedChapter === 'all'
                ? 'bg-white text-indigo-600 border-white shadow-lg'
                : 'bg-white/10 text-white border-white/20 hover:bg-white/20'
            }`}
          >
            ğŸ“š ×”×›×œ ({allCards.length})
          </button>
          {chapters.map(ch => {
            const active = selectedChapter === ch;
            return (
              <button
                key={ch}
                onClick={() => setSelectedChapter(active ? 'all' : ch)}
                className={`flex-shrink-0 px-3 py-1.5 rounded-xl text-xs font-semibold transition-all border-2 whitespace-nowrap ${
                  active
                    ? 'bg-white text-indigo-600 border-white shadow-lg'
                    : 'bg-white/10 text-white border-white/20 hover:bg-white/20'
                }`}
              >
                {ch} ({chapterCounts[ch] || 0})
              </button>
            );
          })}
          
          {/* Divider */}
          <div className="flex-shrink-0 w-px bg-white/20 mx-1"></div>
          
          {/* Status buttons */}
          {statusTabs.map(t => {
            const count = counts[t.key];
            const active = filter === t.key;
            
            return (
              <button 
                key={t.key} 
                onClick={() => setFilter(active ? 'all' : t.key)}
                className={`flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-semibold transition-all border-2 ${
                  active ? t.color + ' border-white' : t.inactive + ' hover:bg-white/20'
                }`}
              >
                {t.emoji} {count ?? 0}
              </button>
            );
          })}
        </div>
      );
    };

    // â”€â”€ Confidence Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ConfidenceButtons = ({ status, onSet }) => (
      <div className="flex gap-3 justify-center no-select">
        {[
          ['red', 'ğŸ”´', '×œ× ×™×•×“×¢'],
          ['yellow', 'ğŸŸ¡', '×›××¢×˜'],
          ['green', 'ğŸŸ¢', '×™×•×“×¢!']
        ].map(([s, emoji, label]) => (
          <button 
            key={s} 
            onClick={() => onSet(s)}
            className={`flex-1 py-3 rounded-2xl text-sm font-bold transition-all active:scale-95 border-2 ${
              status === s
                ? s === 'red' ? 'bg-red-500 text-white border-red-500 shadow-md' 
                : s === 'yellow' ? 'bg-amber-400 text-white border-amber-400 shadow-md' 
                : 'bg-emerald-500 text-white border-emerald-500 shadow-md'
                : 'bg-white text-slate-600 border-slate-200'
            }`}
          >
            <div className="text-xl">{emoji}</div>
            <div className="text-xs">{label}</div>
          </button>
        ))}
      </div>
    );

    // â”€â”€ FLASHCARDS MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FlashcardsMode = ({ cards, statuses, setStatus }) => {
      const [idx, setIdx] = useState(0);
      const [flipped, setFlipped] = useState(false);
      const [shuffled, setShuffled] = useState(false);
      const [deck, setDeck] = useState(cards);
      const [touchStartX, setTouchStartX] = useState(null);

      useEffect(() => {
        setDeck(shuffled ? shuffle(cards) : cards);
        setIdx(0);
        setFlipped(false);
      }, [cards, shuffled]);

      const go = dir => {
        setFlipped(false);
        setTimeout(() => setIdx(i => 
          dir === 'next' ? Math.min(i + 1, deck.length - 1) : Math.max(i - 1, 0)
        ), 120);
      };

      const onTouchStart = e => setTouchStartX(e.touches[0].clientX);
      const onTouchEnd = e => {
        if (touchStartX === null) return;
        const diff = touchStartX - e.changedTouches[0].clientX;
        if (diff > 50 && idx < deck.length - 1) go('next');
        else if (diff < -50 && idx > 0) go('prev');
        setTouchStartX(null);
      };

      const card = deck[idx];
      const cardStatus = card ? (statuses[card.id] || 'unmarked') : 'unmarked';

      // Keyboard navigation
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' && idx < deck.length - 1) {
            go('next');
          } else if (e.key === 'ArrowLeft' && idx > 0) {
            go('prev');
          } else if (e.key === ' ' || e.code === 'Space') {
            e.preventDefault();
            setFlipped(f => !f);
          }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [idx, deck.length]);

      if (!deck.length) return (
        <div className="flex flex-col items-center justify-center h-64 text-slate-400">
          <div className="text-5xl mb-4">ğŸ˜´</div>
          <p className="text-lg font-medium">××™×Ÿ × ×•×¡×—××•×ª ×‘×¤×™×œ×˜×¨ ×–×”</p>
          <p className="text-sm mt-2">×©× ×” ××ª ×”×¤×™×œ×˜×¨ ×œ××¢×œ×”</p>
        </div>
      );

      return (
        <div className="flex flex-col gap-5">
          {/* Progress bar */}
          <div className="flex items-center gap-3">
            <div className="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
              <div className="h-full bg-gradient-to-r from-indigo-400 to-violet-500 rounded-full transition-all" 
                style={{ width: `${((idx + 1) / deck.length) * 100}%` }} />
            </div>
            <span className="text-sm font-semibold text-white shrink-0">{idx + 1} / {deck.length}</span>
            <button 
              onClick={() => setShuffled(s => !s)}
              className={`p-2 rounded-xl border transition-all ${
                shuffled ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200'
              }`}
            >
              <IconShuffle />
            </button>
          </div>

          {/* Navigation arrows */}
          <div className="relative">
            <button 
              onClick={() => go('prev')} 
              disabled={idx === 0}
              className="hidden md:flex absolute left-0 top-1/2 -translate-y-1/2 -translate-x-16 w-12 h-12 items-center justify-center bg-white rounded-full shadow-lg border border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all z-10"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            
            <button 
              onClick={() => go('next')} 
              disabled={idx === deck.length - 1}
              className="hidden md:flex absolute right-0 top-1/2 -translate-y-1/2 translate-x-16 w-12 h-12 items-center justify-center bg-white rounded-full shadow-lg border border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all z-10"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
              </svg>
            </button>

            {/* Card */}
            <div 
              className="card-container w-full" 
              style={{ height: '65vh', minHeight: '400px' }} 
              onTouchStart={onTouchStart} 
              onTouchEnd={onTouchEnd}
            >
              <div className={`card-inner w-full h-full ${flipped ? 'flipped' : ''}`} onClick={() => setFlipped(f => !f)}>
                {/* Front: Topic + Name */}
                <div className={`card-face bg-white shadow-2xl border-2 ${getStatusBorder(cardStatus)} flex flex-col p-8 cursor-pointer`}>
                  <div className="flex flex-col items-center justify-center w-full h-full">
                    <div className="w-full mb-4 text-center">
                      <div className="inline-block px-4 py-2 rounded-full bg-indigo-100 text-indigo-700 text-sm font-bold mb-6">
                        {card.topic}
                      </div>
                    </div>
                    <h2 className="text-center text-slate-800 font-black text-2xl md:text-3xl leading-snug mb-auto">
                      {card.name}
                    </h2>
                    <div className="pt-4 text-slate-400 text-xs flex justify-center items-center gap-2 w-full mt-auto">
                      <IconFlip />
                      <span>×œ×—×¥ ×œ×¨××•×ª × ×•×¡×—×”</span>
                    </div>
                  </div>
                </div>

                {/* Back: Formula (KaTeX) */}
                <div className="card-face card-back gradient-card shadow-2xl flex flex-col p-8 cursor-pointer">
                  <div className="flex flex-col items-center justify-center w-full h-full">
                    <div className="w-full mb-4 text-center">
                      <div className="inline-block px-4 py-2 rounded-full bg-white/20 text-white text-sm font-bold mb-4">
                        {card.topic}
                      </div>
                    </div>
                    <div className="text-center text-white/80 font-semibold text-lg mb-4">
                      {card.name}
                    </div>
                    <div className="w-full flex items-center justify-center my-auto">
                      <MathDisplay 
                        latex={card.formula} 
                        displayMode={true} 
                        className="text-white text-2xl md:text-3xl"
                      />
                    </div>
                    <div className="pt-4 text-white/60 text-xs flex justify-center items-center gap-2 w-full mt-auto">
                      <IconFlip />
                      <span>×œ×—×¥ ×œ×—×–×•×¨</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Status buttons */}
          <ConfidenceButtons status={cardStatus} onSet={s => setStatus(card.id, s)} />

          {/* Navigation buttons (mobile) */}
          <div className="flex gap-3 md:hidden">
            <button 
              onClick={() => go('prev')} 
              disabled={idx === 0} 
              className="flex-1 py-4 rounded-2xl font-bold text-slate-600 bg-white border border-slate-200 disabled:opacity-30 active:scale-95 transition-all text-lg"
            >
              â† ×”×§×•×“×
            </button>
            <button 
              onClick={() => go('next')} 
              disabled={idx === deck.length - 1} 
              className="flex-1 py-4 rounded-2xl font-bold text-white bg-indigo-600 disabled:opacity-30 active:scale-95 transition-all shadow-md text-lg"
            >
              ×”×‘× â†’
            </button>
          </div>
          
          {/* Desktop hint */}
          <div className="hidden md:block text-center text-xs text-white/60 mt-2">
            ğŸ’¡ ×˜×™×¤: ×”×©×ª××© ×‘-<span className="font-bold">×—×¦×™× â†â†’</span> ×œ× ×™×•×•×˜ ×•-<span className="font-bold">×¨×•×•×—</span> ×œ×”×¤×™×›×ª ×”×›×¨×˜×™×¡
          </div>
        </div>
      );
    };

    // â”€â”€ TEST MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const buildQuiz = (cards, count) => {
      return shuffle(cards).slice(0, Math.min(count, cards.length)).map(card => {
        const correct = card.formula;
        const wrongs = (card.wrong_answers || []).slice(0, 3);
        const options = shuffle([correct, ...wrongs]);
        return {
          id: card.id,
          question: card.name,
          topic: card.topic,
          correct,
          options
        };
      });
    };

    const TestMode = ({ cards, userData, updateUserData }) => {
      const [quiz, setQuiz] = useState(null);
      const [answers, setAnswers] = useState({});
      const [submitted, setSubmitted] = useState(false);
      const [shakeSubmit, setShakeSubmit] = useState(false);
      const [count, setCount] = useState(20);

      const startQuiz = () => {
        setQuiz(buildQuiz(cards, count));
        setAnswers({});
        setSubmitted(false);
      };

      const pick = (qid, opt) => {
        if (submitted) return;
        setAnswers(a => ({ ...a, [qid]: opt }));
      };

      const submit = () => {
        if (quiz.some(q => !answers[q.id])) {
          setShakeSubmit(true);
          setTimeout(() => setShakeSubmit(false), 500);
          return;
        }
        
        const score = quiz.filter(q => answers[q.id] === q.correct).length;
        const pct = Math.round((score / quiz.length) * 100);
        
        // Update high score
        const newQuizzesTaken = (userData.quizzesTaken || 0) + 1;
        const newHighScore = Math.max(userData.highScore || 0, pct);
        
        updateUserData({
          highScore: newHighScore,
          quizzesTaken: newQuizzesTaken
        });
        
        setSubmitted(true);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      if (!cards.length) return (
        <div className="flex flex-col items-center justify-center h-64 text-white/60">
          <div className="text-5xl mb-4">ğŸš«</div>
          <p className="font-medium">××™×Ÿ × ×•×¡×—××•×ª ×‘×¤×™×œ×˜×¨ ×–×”</p>
          <p className="text-sm mt-1">×©× ×” ×¤×™×œ×˜×¨ ×œ××¢×œ×”</p>
        </div>
      );

      if (!quiz) {
        return (
          <div className="flex flex-col items-center gap-5 py-8">
            <div className="text-6xl">ğŸ“</div>
            <div className="text-center">
              <h2 className="text-2xl font-bold text-white">××‘×—×Ÿ × ×•×¡×—××•×ª</h2>
              <p className="text-violet-200 mt-1">{cards.length} × ×•×¡×—××•×ª ×–××™× ×•×ª</p>
            </div>

            {/* Stats */}
            {(userData.quizzesTaken > 0 || userData.highScore > 0) && (
              <div className="w-full bg-white/10 backdrop-blur rounded-2xl p-4 border border-white/20">
                <div className="flex justify-around">
                  <div className="text-center">
                    <div className="text-3xl font-black text-white">{userData.highScore || 0}%</div>
                    <div className="text-xs text-violet-200">×©×™× ××™×©×™</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-black text-white">{userData.quizzesTaken || 0}</div>
                    <div className="text-xs text-violet-200">××‘×—× ×™×</div>
                  </div>
                </div>
              </div>
            )}

            {/* Count selector */}
            <div className="w-full bg-white/10 backdrop-blur rounded-2xl p-4 border border-white/20">
              <p className="text-white font-semibold text-sm mb-3 text-center">×›××” ×©××œ×•×ª?</p>
              <div className="flex gap-2 flex-wrap justify-center">
                {[10, 20, 30, 50, cards.length].filter((v, i, arr) => 
                  arr.indexOf(v) === i && v <= cards.length
                ).map(n => (
                  <button 
                    key={n} 
                    onClick={() => setCount(n)}
                    className={`px-4 py-2 rounded-xl font-bold text-sm transition-all ${
                      count === n ? 'bg-indigo-500 text-white' : 'bg-white/20 text-white'
                    }`}
                  >
                    {n === cards.length ? `×›×œ (${n})` : n}
                  </button>
                ))}
              </div>
            </div>

            <button 
              onClick={startQuiz} 
              className="w-full py-4 rounded-2xl bg-white text-indigo-600 font-black text-lg shadow-lg active:scale-95 transition-all"
            >
              ×”×ª×—×œ ××‘×—×Ÿ ğŸš€
            </button>
          </div>
        );
      }

      if (submitted) {
        const score = quiz.filter(q => answers[q.id] === q.correct).length;
        const pct = Math.round((score / quiz.length) * 100);
        const emoji = pct >= 80 ? 'ğŸ‰' : pct >= 50 ? 'ğŸ’ª' : 'ğŸ˜…';
        const isNewHighScore = pct > (userData.highScore || 0);
        
        return (
          <div className="flex flex-col gap-4">
            <div className={`rounded-2xl p-6 text-center text-white shadow-lg ${
              pct >= 80 ? 'bg-gradient-to-r from-emerald-500 to-green-600' 
              : pct >= 50 ? 'bg-gradient-to-r from-amber-400 to-orange-500' 
              : 'bg-gradient-to-r from-red-500 to-pink-600'
            }`}>
              <div className="text-5xl mb-2">{emoji}</div>
              <div className="text-4xl font-black">{pct}%</div>
              <div className="text-lg opacity-90">{score} / {quiz.length} × ×›×•×Ÿ</div>
              {isNewHighScore && (
                <div className="mt-2 text-sm font-bold bg-white/20 rounded-full px-4 py-1 inline-block">
                  ğŸ† ×©×™× ×—×“×©!
                </div>
              )}
            </div>

            <button 
              onClick={startQuiz} 
              className="w-full py-4 rounded-2xl bg-white text-indigo-600 font-bold text-lg shadow-md active:scale-95 transition-all"
            >
              × ×¡×” ×©×•×‘ ğŸ”„
            </button>

            <div className="flex flex-col gap-3">
              {quiz.map((q, i) => {
                const correct = answers[q.id] === q.correct;
                return (
                  <div 
                    key={q.id} 
                    className={`rounded-2xl p-4 border-2 ${
                      correct ? 'border-emerald-300 bg-emerald-50' : 'border-red-300 bg-red-50'
                    }`}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div className="text-xs font-bold uppercase tracking-wide text-slate-500">×©{i + 1}</div>
                      <div className="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold">
                        {q.topic}
                      </div>
                    </div>
                    <p className="font-semibold text-slate-800 text-sm mb-3">{q.question}</p>
                    {!correct && (
                      <div className="mb-2 p-2 bg-red-100 rounded-lg">
                        <div className="text-red-600 text-xs mb-1 font-semibold">âŒ ×¢× ×™×ª:</div>
                        <MathDisplay latex={answers[q.id]} displayMode={false} className="text-red-700" />
                      </div>
                    )}
                    <div className="p-2 bg-emerald-100 rounded-lg">
                      <div className="text-emerald-700 text-xs mb-1 font-semibold">âœ… × ×›×•×Ÿ:</div>
                      <MathDisplay latex={q.correct} displayMode={false} className="text-emerald-800" />
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col gap-4">
          {/* Progress */}
          <div className="flex items-center gap-3">
            <div className="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
              <div 
                className="h-full bg-gradient-to-r from-indigo-400 to-violet-500 rounded-full transition-all" 
                style={{ width: `${(Object.keys(answers).length / quiz.length) * 100}%` }} 
              />
            </div>
            <span className="text-sm font-semibold text-white shrink-0">
              {Object.keys(answers).length}/{quiz.length}
            </span>
          </div>

          {/* Questions */}
          {quiz.map((q, i) => (
            <div key={q.id} className="bg-white/95 backdrop-blur rounded-2xl shadow-lg border border-white/20 p-5">
              <div className="flex items-center justify-between mb-3">
                <div className="text-xs font-bold text-indigo-600 uppercase tracking-widest">×©××œ×” {i + 1}</div>
                <div className="px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold">
                  {q.topic}
                </div>
              </div>
              <p className="font-bold text-slate-800 mb-4 text-base">××”×™ ×”× ×•×¡×—×” ×©×œ: {q.question}</p>
              
              <div className="flex flex-col gap-3">
                {q.options.map((opt, j) => (
                  <button 
                    key={j} 
                    onClick={() => pick(q.id, opt)}
                    className={`math-option text-right rounded-xl border-2 font-medium transition-all active:scale-98 ${
                      answers[q.id] === opt 
                        ? 'border-indigo-500 bg-indigo-50' 
                        : 'border-slate-200 bg-white hover:border-slate-300'
                    }`}
                  >
                    <span className="ml-3 font-bold text-slate-400 text-sm">{String.fromCharCode(65 + j)}.</span>
                    <MathDisplay latex={opt} displayMode={false} className="inline-block text-slate-800 ml-3" />
                  </button>
                ))}
              </div>
            </div>
          ))}

          <button 
            onClick={submit} 
            className={`w-full py-4 rounded-2xl font-bold text-lg transition-all active:scale-95 shadow-lg bg-white text-indigo-600 ${
              shakeSubmit ? 'shake' : ''
            }`}
          >
            ×”×’×© ××‘×—×Ÿ âœ“
          </button>
        </div>
      );
    };

    // â”€â”€ LIST MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ListMode = ({ cards, statuses }) => {
      const [search, setSearch] = useState('');
      const [hideAnswers, setHideAnswers] = useState(false);
      const [revealed, setRevealed] = useState({});

      const toggleHide = () => {
        setHideAnswers(h => !h);
        setRevealed({});
      };

      const revealCard = id => setRevealed(r => ({ ...r, [id]: true }));

      const filtered = cards.filter(c =>
        !search || 
        c.name.toLowerCase().includes(search.toLowerCase()) || 
        c.topic.toLowerCase().includes(search.toLowerCase())
      );

      if (cards.length === 0) {
        return (
          <div className="flex flex-col items-center justify-center h-64 text-white/60">
            <div className="text-5xl mb-4">ğŸ˜´</div>
            <p className="text-lg font-medium">××™×Ÿ × ×•×¡×—××•×ª ×‘×¤×™×œ×˜×¨ ×–×”</p>
            <p className="text-sm mt-2">×©× ×” ××ª ×”×¤×™×œ×˜×¨ ×œ××¢×œ×”</p>
          </div>
        );
      }

      return (
        <div className="flex flex-col gap-3">
          {/* Controls */}
          <div className="flex gap-2">
            <input 
              value={search} 
              onChange={e => setSearch(e.target.value)} 
              placeholder="ğŸ” ×—×™×¤×•×© × ×•×¡×—×”..."
              className="flex-1 px-4 py-3 rounded-2xl border-2 border-white/20 bg-white/10 backdrop-blur text-white placeholder-white/50 outline-none focus:border-white/40 transition-all"
              dir="auto"
            />
            <button 
              onClick={toggleHide}
              className={`shrink-0 px-4 py-3 rounded-2xl font-bold text-sm transition-all border-2 active:scale-95 ${
                hideAnswers 
                  ? 'bg-white text-indigo-600 border-white' 
                  : 'bg-white/10 text-white border-white/20'
              }`}
            >
              {hideAnswers ? 'ğŸ™ˆ ××•×¡×ª×¨' : 'ğŸ‘ ×’×œ×•×™'}
            </button>
          </div>

          {hideAnswers && (
            <div className="bg-indigo-500/20 border border-indigo-400/30 rounded-xl px-4 py-2 text-white text-xs font-medium backdrop-blur">
              ğŸ’¡ ×œ×—×¥ "×’×œ×”" ×›×“×™ ×œ×¨××•×ª ××ª ×”× ×•×¡×—×”
            </div>
          )}

          <div className="flex flex-col gap-3">
            {filtered.map(card => {
              const s = statuses[card.id] || 'unmarked';
              const isRevealed = revealed[card.id];

              return (
                <div 
                  key={card.id} 
                  className={`bg-white/95 backdrop-blur rounded-2xl p-4 shadow-lg border-l-4 status-${s}`}
                >
                  <div className="flex items-start gap-3">
                    <StatusDot status={s} />
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start justify-between gap-2 mb-2">
                        <h3 className="font-bold text-slate-800 text-base">{card.name}</h3>
                        <div className="px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold shrink-0">
                          {card.topic}
                        </div>
                      </div>

                      {hideAnswers && !isRevealed ? (
                        <button 
                          onClick={() => revealCard(card.id)}
                          className="w-full py-3 rounded-xl bg-indigo-600 text-white text-sm font-bold active:scale-95 transition-all mt-3"
                        >
                          ×’×œ×” × ×•×¡×—×” âœ“
                        </button>
                      ) : (
                        <div className="mt-3 p-3 bg-gradient-to-r from-indigo-50 to-violet-50 rounded-xl border border-indigo-100">
                          <MathDisplay 
                            latex={card.formula} 
                            displayMode={true} 
                            className="text-slate-800"
                          />
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
            
            {!filtered.length && (
              <div className="text-center text-white/60 py-10">×œ× × ××¦××• ×ª×•×¦××•×ª</div>
            )}
          </div>
        </div>
      );
    };

    // â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const App = () => {
      const [currentUser, setCurrentUser] = useState(() => loadCurrent());
      const [users, setUsers] = useState(() => loadUsers());
      const [allCards] = useState(() => loadData());
      const [filter, setFilter] = useState('all');
      const [selectedChapter, setSelectedChapter] = useState('all');
      const [mode, setMode] = useState('flashcards');
      const [showNav, setShowNav] = useState(true);
      const [syncing, setSyncing] = useState(false);

      useEffect(() => {
        const handleScroll = () => {
          setShowNav(window.scrollY < 50);
        };
        window.addEventListener('scroll', handleScroll, { passive: true });
        return () => window.removeEventListener('scroll', handleScroll);
      }, []);

      useEffect(() => {
        setSyncing(true);
        syncCloudUsers().then(cloud => {
          if (cloud && Object.keys(cloud).length > 0) {
            setUsers(prev => {
              const m = { ...prev, ...cloud };
              saveUsers(m);
              return m;
            });
          }
        }).finally(() => setSyncing(false));
      }, []);

      const userData = currentUser ? getUserData(users, currentUser) : { statuses: {}, highScore: 0, quizzesTaken: 0 };
      const statuses = userData.statuses || {};

      // Topic to main category mapping (×§×™×‘×•×¥ × ×•×©××™× ×œ×¤×¨×§×™× ×’×“×•×œ×™×)
      const topicToCategory = useMemo(() => ({
        "××™× ×˜×’×¨×‘×™×œ×™×•×ª ×•×¡×›×•××™ ×¨×™××Ÿ": "××™× ×˜×’×¨×œ×™×",
        "×¡×“×¨×•×ª ×•××™× ×˜×’×¨×œ×™×": "××™× ×˜×’×¨×œ×™×",
        "××™× ×˜×’×¨×œ×™×": "××™× ×˜×’×¨×œ×™×",
        "××™× ×˜×’×¨×œ×™× ××•×›×œ×œ×™×": "××™× ×˜×’×¨×œ×™×",
        "××™× ×˜×’×¨×œ×™× ×•×©×™××•×©×™×": "×©×˜×—×™× ×•× ×¤×—×™×",
        "×•×§×˜×•×¨×™×": "×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª",
        "×™×©×¨×™× ×•××™×©×•×¨×™×": "×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª",
        "×–×•×•×™×ª ×•××¨×—×§×™×": "×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª",
        "×”×™×˜×œ×™×": "×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª",
        "×¤×•× ×§×¦×™×•×ª ×¡×ª×•××•×ª": "×¤×•× ×§×¦×™×•×ª ×©×œ ××¡×¤×¨ ××©×ª× ×™×",
        "×¤×•× ×§×¦×™×•×ª ×©×œ ××¡×¤×¨ ××©×ª× ×™×": "×¤×•× ×§×¦×™×•×ª ×©×œ ××¡×¤×¨ ××©×ª× ×™×",
        "×“×™×¤×¨× ×¦×™××‘×™×œ×™×•×ª": "×¤×•× ×§×¦×™×•×ª ×©×œ ××¡×¤×¨ ××©×ª× ×™×",
        "×‘×¢×™×•×ª ×§×™×¦×•×Ÿ": "×§×™×¦×•×Ÿ ×•××™× ×™××™×–×¦×™×”",
        "××™× ×˜×’×¨×œ×™× ×›×¤×•×œ×™× ×•××©×•×œ×©×™×": "××™× ×˜×’×¨×œ×™× ×›×¤×•×œ×™× ×•××©×•×œ×©×™×",
        "××™× ×˜×’×¨×œ×™× ×§×•×•×™×™×": "××™× ×˜×’×¨×œ×™× ×›×¤×•×œ×™× ×•××©×•×œ×©×™×"
      }), []);

      // Extract main categories (×§×˜×’×•×¨×™×•×ª ×’×“×•×œ×•×ª ×‘×œ×‘×“)
      const chapters = useMemo(() => {
        const mainCategories = [...new Set(allCards.map(c => topicToCategory[c.topic] || c.topic))].filter(Boolean);
        return mainCategories.sort();
      }, [allCards, topicToCategory]);

      const setStatus = useCallback((id, status) => {
        if (!currentUser) return;
        setUsers(prev => {
          const newStatuses = { ...getUserData(prev, currentUser).statuses, [id]: status };
          const updated = setUserData(prev, currentUser, { statuses: newStatuses });
          saveUsers(updated);
          pushCloudUser(currentUser, { statuses: newStatuses });
          return updated;
        });
      }, [currentUser]);

      const updateUserData = useCallback((data) => {
        if (!currentUser) return;
        setUsers(prev => {
          const updated = setUserData(prev, currentUser, data);
          saveUsers(updated);
          pushCloudUser(currentUser, data);
          return updated;
        });
      }, [currentUser]);

      const handleLogin = name => setCurrentUser(name);
      
      const handleLogout = () => {
        clearCurrent();
        setCurrentUser(null);
        setFilter('all');
        setSelectedChapter('all');
        setMode('flashcards');
      };

      const resetUser = () => {
        if (!confirm('××™×¤×•×¡ ×›×œ ×”×¡×™××•× ×™× ×©×œ×š?')) return;
        updateUserData({ statuses: {} });
      };

      const counts = useMemo(() => ({
        all: allCards.length,
        red: allCards.filter(c => statuses[c.id] === 'red').length,
        yellow: allCards.filter(c => statuses[c.id] === 'yellow').length,
        green: allCards.filter(c => statuses[c.id] === 'green').length,
        unmarked: allCards.filter(c => !statuses[c.id] || statuses[c.id] === 'unmarked').length,
      }), [allCards, statuses]);

      const filteredCards = useMemo(() => {
        let cards = allCards;
        
        // Filter by main category first
        if (selectedChapter !== 'all') {
          cards = cards.filter(c => (topicToCategory[c.topic] || c.topic) === selectedChapter);
        }
        
        // Then filter by status
        if (filter !== 'all') {
          cards = cards.filter(c => (statuses[c.id] || 'unmarked') === filter);
        }
        
        return cards;
      }, [allCards, statuses, filter, selectedChapter, topicToCategory]);

      if (!currentUser) return <LoginScreen onLogin={handleLogin} />;

      const tabs = [
        { key: 'flashcards', label: '×›×¨×˜×™×¡×™×', icon: <IconCards /> },
        { key: 'test', label: '××‘×—×Ÿ', icon: <IconTest /> },
        { key: 'list', label: '×¨×©×™××”', icon: <IconList /> },
      ];

      return (
        <div className="min-h-screen gradient-bg">
          {/* Header */}
          <div className={`fixed top-0 left-0 right-0 z-30 bg-indigo-900/95 backdrop-blur border-b border-white/10 shadow-lg transition-transform duration-300 ${
            showNav ? 'translate-y-0' : '-translate-y-full'
          }`}>
            <div className="max-w-lg md:max-w-3xl mx-auto px-4 pt-3 pb-3 flex flex-col gap-3">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-xl font-black text-white flex items-center gap-2">
                    <span className="text-2xl">âˆ«</span> Calculus 2 Pro
                  </h1>
                  <p className="text-xs text-violet-300">
                    {selectedChapter === 'all' 
                      ? `${allCards.length} × ×•×¡×—××•×ª` 
                      : `${filteredCards.length} × ×•×¡×—××•×ª â€¢ ${selectedChapter}`
                    } â€¢ {counts.green} × ×œ××“×•
                    {syncing && <span className="ml-2">ğŸ”„</span>}
                  </p>
                </div>
                <div className="flex items-center gap-2">
                  <button 
                    onClick={handleLogout}
                    className="flex items-center gap-1.5 text-xs text-white bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-xl transition-all font-semibold border border-white/20"
                  >
                    <IconUser />{currentUser}
                  </button>
                  <button 
                    onClick={resetUser} 
                    className="text-xs text-white/70 hover:text-white bg-white/10 px-3 py-1.5 rounded-xl transition-all border border-white/20"
                  >
                    ××™×¤×•×¡
                  </button>
                </div>
              </div>
              <CombinedFilterBar
                filter={filter}
                setFilter={setFilter}
                counts={counts}
                chapters={chapters}
                selectedChapter={selectedChapter}
                setSelectedChapter={setSelectedChapter}
                allCards={allCards}
                topicToCategory={topicToCategory}
              />
            </div>
          </div>

          <div className="max-w-lg md:max-w-3xl mx-auto px-4 pt-36">
            {/* Mode tabs */}
            <div className="flex bg-white/10 backdrop-blur rounded-2xl p-1 shadow-lg border border-white/20 mb-5">
              {tabs.map(t => (
                <button 
                  key={t.key} 
                  onClick={() => setMode(t.key)}
                  className={`flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl text-sm font-bold transition-all ${
                    mode === t.key 
                      ? 'bg-white text-indigo-600 shadow-md' 
                      : 'text-white/70'
                  }`}
                >
                  {t.icon}<span>{t.label}</span>
                </button>
              ))}
            </div>

            <div className="pb-10">
              {mode === 'flashcards' && <FlashcardsMode cards={filteredCards} statuses={statuses} setStatus={setStatus} />}
              {mode === 'test' && <TestMode cards={filteredCards} userData={userData} updateUserData={updateUserData} />}
              {mode === 'list' && <ListMode cards={filteredCards} statuses={statuses} />}
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
  <script>window.__QUIZ_DATA__ = null;</script>
  <script src="quiz_data.js"></script>
  
  <!-- PWA Service Worker Registration & Install Prompt -->
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('âœ… SW registered:', registration.scope);
          })
          .catch((error) => {
            console.log('âŒ SW registration failed:', error);
          });
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    const installButton = document.createElement('button');
    installButton.textContent = 'ğŸ“± ×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”';
    installButton.className = 'fixed bottom-4 left-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl shadow-lg font-bold text-sm z-50 hover:scale-105 transition-transform';
    installButton.style.display = 'none';

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Check if already installed
      if (!window.matchMedia('(display-mode: standalone)').matches) {
        installButton.style.display = 'block';
        document.body.appendChild(installButton);
      }
    });

    installButton.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('âœ… User accepted PWA install');
        installButton.style.display = 'none';
      }
      
      deferredPrompt = null;
    });

    // Hide install button if already in standalone mode
    if (window.matchMedia('(display-mode: standalone)').matches || 
        window.navigator.standalone === true) {
      console.log('âœ… Running as installed PWA');
    }

    // iOS specific - Add to Home Screen hint
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
    
    if (isIOS && !isInStandaloneMode) {
      // Show iOS install instructions after 3 seconds
      setTimeout(() => {
        const iosHint = document.createElement('div');
        iosHint.innerHTML = `
          <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      color: white; padding: 15px 25px; border-radius: 15px; 
                      box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; 
                      max-width: 90%; text-align: center; font-size: 14px;
                      animation: slideUp 0.5s ease-out;">
            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ’¡ ×”×ª×§×Ÿ ×¢×œ ×”××›×©×™×¨</div>
            <div style="font-size: 13px; opacity: 0.95;">
              ×œ×—×¥ ×¢×œ <span style="font-size: 18px;">â™</span> ×•×‘×—×¨ "×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª"
            </div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="margin-top: 10px; background: white; color: #667eea; 
                           border: none; padding: 8px 20px; border-radius: 8px; 
                           font-weight: bold; cursor: pointer;">
              ×”×‘× ×ª×™ âœ“
            </button>
          </div>
        `;
        document.body.appendChild(iosHint);
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
          if (iosHint.parentElement) {
            iosHint.remove();
          }
        }, 10000);
      }, 3000);
    }

    // Persist user session in localStorage (for PWA standalone)
    window.addEventListener('beforeunload', () => {
      // User data is already being saved by the app's sync mechanism
      console.log('ğŸ’¾ Session data persisted');
    });

    // Handle app updates
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // New service worker activated, reload to get fresh content
        if (confirm('×™×© ×¢×“×›×•×Ÿ ×—×“×©! ×œ×¨×¢× ×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”?')) {
          window.location.reload();
        }
      });
    }
  </script>
  
  <style>
    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
  </style>
</body>

</html>
